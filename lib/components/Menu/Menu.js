var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _react=_interopRequireDefault(require("react"));var _reactNative=require("react-native");var _providers=require("../../providers");var _theme=require("../../theme");var _styles=_interopRequireDefault(require("./styles"));var _types=require("./types");var _jsxRuntime=require("react/jsx-runtime");var _excluded=["width","height","maxWidth","maxHeight","borderRadius","defaultOpened","disabled","withArrow","children"];var _this=this,_jsxFileName="/Users/limonagaci/Desktop/app/dohrnii/src/components/Menu/Menu.js";var MenuTarget=function MenuTarget(_ref){var children=_ref.children;return children;};MenuTarget.displayName='MenuTarget';var MenuDropdown=function MenuDropdown(_ref2){var children=_ref2.children,style=_ref2.style;return(0,_jsxRuntime.jsx)(_reactNative.View,{style:style,children:children});};MenuDropdown.displayName='MenuDropdown';var ARROW_SIZE=12;var SCREEN_MARGIN=8;var Menu=function Menu(props){var _themeMode$colors,_themeMode$colors2,_themeMode$colors3,_themeMode$colors4,_dropdownChild$props;var _useTheme=(0,_providers.useTheme)(),themeMode=_useTheme.theme;var styles=(0,_styles.default)(themeMode);var _MenuDefaultProps$pro=Object.assign({},_types.MenuDefaultProps,props),width=_MenuDefaultProps$pro.width,height=_MenuDefaultProps$pro.height,maxWidth=_MenuDefaultProps$pro.maxWidth,maxHeight=_MenuDefaultProps$pro.maxHeight,borderRadius=_MenuDefaultProps$pro.borderRadius,defaultOpened=_MenuDefaultProps$pro.defaultOpened,disabled=_MenuDefaultProps$pro.disabled,withArrow=_MenuDefaultProps$pro.withArrow,children=_MenuDefaultProps$pro.children,rest=(0,_objectWithoutProperties2.default)(_MenuDefaultProps$pro,_excluded);var _React$useState=_react.default.useState(!!defaultOpened),_React$useState2=(0,_slicedToArray2.default)(_React$useState,2),open=_React$useState2[0],setOpen=_React$useState2[1];var overlayOpacity=_react.default.useRef(new _reactNative.Animated.Value(0)).current;var targetRef=_react.default.useRef(null);var dropdownLayoutRef=_react.default.useRef({width:0,height:0});var _React$useState3=_react.default.useState({x:0,y:0,width:0,height:0}),_React$useState4=(0,_slicedToArray2.default)(_React$useState3,2),targetRect=_React$useState4[0],setTargetRect=_React$useState4[1];var _React$useState5=_react.default.useState({top:0,left:0,openDirection:'down',align:'left'}),_React$useState6=(0,_slicedToArray2.default)(_React$useState5,2),dropdownPos=_React$useState6[0],setDropdownPos=_React$useState6[1];var window=_reactNative.Dimensions.get('window');var childrenArray=_react.default.Children.toArray(children);var targetChild=childrenArray.find(function(c){var _c$type;return(c==null||(_c$type=c.type)==null?void 0:_c$type.displayName)==='MenuTarget';});var dropdownChild=childrenArray.find(function(c){var _c$type2;return(c==null||(_c$type2=c.type)==null?void 0:_c$type2.displayName)==='MenuDropdown';});var measureTarget=_react.default.useCallback(function(){if(targetRef.current&&targetRef.current.measureInWindow){targetRef.current.measureInWindow(function(x,y,w,h){setTargetRect({x:x,y:y,width:w,height:h});});}},[]);_react.default.useEffect(function(){if(open){overlayOpacity.setValue(0);_reactNative.Animated.sequence([_reactNative.Animated.delay(120),_reactNative.Animated.timing(overlayOpacity,{toValue:1,duration:200,useNativeDriver:true})]).start();setTimeout(measureTarget,0);}else{overlayOpacity.setValue(0);}},[open,measureTarget,overlayOpacity]);var resolveSize=function resolveSize(value,fallbackPx){if(typeof value==='number')return value;if(typeof value==='string'){if(value.endsWith('%')){var pct=parseFloat(value);return Math.max(0,Math.min(window.width,pct/100*window.width));}if(value==='auto')return fallbackPx;}return fallbackPx;};var computePosition=_react.default.useCallback(function(){var contentW=resolveSize(width,dropdownLayoutRef.current.width||0);var contentH=resolveSize(height,dropdownLayoutRef.current.height||0);var maxW=resolveSize(maxWidth,window.width*0.9);var maxH=resolveSize(maxHeight,window.height*0.9);var dw=Math.min(contentW||maxW,maxW);var dh=Math.min(contentH||maxH,maxH);var left=targetRect.x;var align='left';if(left+dw+SCREEN_MARGIN>window.width){left=Math.max(SCREEN_MARGIN,targetRect.x+targetRect.width-dw);align='right';}else{left=Math.max(SCREEN_MARGIN,left);}var top=targetRect.y+targetRect.height+ARROW_SIZE;var openDirection='down';if(top+dh+SCREEN_MARGIN>window.height){top=Math.max(SCREEN_MARGIN,targetRect.y-dh-ARROW_SIZE);openDirection='up';}setDropdownPos({top:top,left:left,openDirection:openDirection,align:align});},[height,maxHeight,maxWidth,width,targetRect,window.height,window.width]);var onDropdownLayout=_react.default.useCallback(function(e){var _e$nativeEvent$layout=e.nativeEvent.layout,lw=_e$nativeEvent$layout.width,lh=_e$nativeEvent$layout.height;dropdownLayoutRef.current={width:lw,height:lh};computePosition();},[computePosition]);var bgColor=(0,_theme.processColorValue)(themeMode==null||(_themeMode$colors=themeMode.colors)==null||(_themeMode$colors=_themeMode$colors.menu)==null?void 0:_themeMode$colors.backgroundColor)||(themeMode==null||(_themeMode$colors2=themeMode.colors)==null?void 0:_themeMode$colors2.white)||'#fff';var borderColor=(0,_theme.processColorValue)(themeMode==null||(_themeMode$colors3=themeMode.colors)==null||(_themeMode$colors3=_themeMode$colors3.gray)==null?void 0:_themeMode$colors3[2])||(themeMode==null||(_themeMode$colors4=themeMode.colors)==null||(_themeMode$colors4=_themeMode$colors4.gray)==null?void 0:_themeMode$colors4[2]);var arrowStyle=function(_themeMode$colors5){var base={width:ARROW_SIZE,height:ARROW_SIZE,backgroundColor:bgColor,position:'absolute',transform:[{rotate:'45deg'}],borderTopLeftRadius:2,borderTopWidth:1,borderLeftWidth:1,borderColor:(themeMode==null||(_themeMode$colors5=themeMode.colors)==null||(_themeMode$colors5=_themeMode$colors5.border)==null?void 0:_themeMode$colors5.light)||borderColor};if(dropdownPos.openDirection==='down'){return Object.assign({},base,{top:dropdownPos.top-ARROW_SIZE/2,left:dropdownPos.align==='left'?Math.max(SCREEN_MARGIN,targetRect.x+targetRect.width/2-ARROW_SIZE/2):Math.min(window.width-SCREEN_MARGIN-ARROW_SIZE,targetRect.x+targetRect.width/2-ARROW_SIZE/2)});}return Object.assign({},base,{top:dropdownPos.top+resolveSize(height,dropdownLayoutRef.current.height||0)+ARROW_SIZE/2,left:dropdownPos.align==='left'?Math.max(SCREEN_MARGIN,targetRect.x+targetRect.width/2-ARROW_SIZE/2):Math.min(window.width-SCREEN_MARGIN-ARROW_SIZE,targetRect.x+targetRect.width/2-ARROW_SIZE/2)});}();var dropdownContainerStyle=[styles.dropdownContainer,{top:dropdownPos.top,left:dropdownPos.left,borderRadius:borderRadius,backgroundColor:bgColor,borderColor:borderColor,maxWidth:resolveSize(maxWidth,window.width*0.9),maxHeight:resolveSize(maxHeight,window.height*0.9),width:width?resolveSize(width,dropdownLayoutRef.current.width||undefined):undefined,height:height?resolveSize(height,dropdownLayoutRef.current.height||undefined):undefined,opacity:1}];var shouldShowArrow=!!withArrow&&targetRect.width>0;var handleToggle=function handleToggle(){if(disabled)return;setOpen(function(prev){return!prev;});};var handleClose=function handleClose(){return setOpen(false);};var enhanceChildrenWithClose=_react.default.useCallback(function(nodes){return _react.default.Children.map(nodes,function(child){var _child$props,_child$props3;if(!_react.default.isValidElement(child))return child;var hasOnPress=typeof((_child$props=child.props)==null?void 0:_child$props.onPress)==='function';var nextProps={};if(hasOnPress){nextProps.onPress=function(){try{var _child$props2;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}child.props.onPress==null||(_child$props2=child.props).onPress.apply(_child$props2,args);}finally{handleClose();}};}if((_child$props3=child.props)!=null&&_child$props3.children){nextProps.children=enhanceChildrenWithClose(child.props.children);}return _react.default.cloneElement(child,nextProps);});},[]);var enhanceTargetChildrenWithToggle=_react.default.useCallback(function(nodes){if(disabled)return nodes;return _react.default.Children.map(nodes,function(child){var _child$props4,_child$props6;if(!_react.default.isValidElement(child))return child;var hasOnPress=typeof((_child$props4=child.props)==null?void 0:_child$props4.onPress)==='function';var nextProps={};nextProps.onPress=function(){try{var _child$props5;for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}if(hasOnPress)child.props.onPress==null||(_child$props5=child.props).onPress.apply(_child$props5,args);}finally{handleToggle();}};if((_child$props6=child.props)!=null&&_child$props6.children){nextProps.children=enhanceTargetChildrenWithToggle(child.props.children);}return _react.default.cloneElement(child,nextProps);});},[disabled]);return(0,_jsxRuntime.jsxs)(_reactNative.View,Object.assign({},rest,{children:[targetChild?(0,_jsxRuntime.jsx)(_reactNative.Pressable,{ref:targetRef,onLayout:function onLayout(){},onPress:handleToggle,children:enhanceTargetChildrenWithToggle(targetChild.props.children)}):null,(0,_jsxRuntime.jsx)(_reactNative.Modal,{visible:open&&!!dropdownChild,transparent:true,animationType:"fade",onRequestClose:handleClose,children:(0,_jsxRuntime.jsxs)(_reactNative.Pressable,{style:{flex:1},onPress:handleClose,children:[(0,_jsxRuntime.jsx)(_reactNative.Animated.View,{pointerEvents:"none",style:{position:'absolute',top:0,left:0,right:0,bottom:0,backgroundColor:"transparent",opacity:overlayOpacity}}),(0,_jsxRuntime.jsx)(_reactNative.Pressable,{style:dropdownContainerStyle,onPress:handleClose,onLayout:onDropdownLayout,children:(0,_jsxRuntime.jsx)(_reactNative.ScrollView,{bounces:false,showsVerticalScrollIndicator:true,style:{flexGrow:0},children:enhanceChildrenWithClose(dropdownChild==null||(_dropdownChild$props=dropdownChild.props)==null?void 0:_dropdownChild$props.children)})}),shouldShowArrow?(0,_jsxRuntime.jsx)(_reactNative.View,{style:arrowStyle}):null]})})]}));};Menu.propTypes=_types.MenuPropTypes;Menu.defaultProps=_types.MenuDefaultProps;Menu.Target=MenuTarget;Menu.Dropdown=MenuDropdown;var _default=exports.default=Menu;